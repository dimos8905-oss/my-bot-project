<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ß–∞—Ç —Å {{ username }}</title>
<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<style>
/* ==== –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –®–ê–ë–õ–û–ù–û–í –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ==== */

/* –ü–∞–Ω–µ–ª—å —à–∞–±–ª–æ–Ω–æ–≤ */
.templates-panel {
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  padding: 0.75rem 1.5rem;
  display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  flex-wrap: wrap;
  gap: 0.5rem;
  max-height: 120px;
  overflow-y: auto;
}

.templates-panel.active {
  display: flex;
}

.template-btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  background: var(--bg-primary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.875rem;
  transition: var(--transition);
  white-space: nowrap;
}

.template-btn:hover {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
  transform: translateY(-1px);
}

.template-btn.category {
  background: var(--accent-color);
  color: white;
  font-weight: 600;
}

.manage-templates-link {
  margin-left: auto;
  font-size: 0.875rem;
  color: var(--accent-color);
  cursor: pointer;
  text-decoration: underline;
}

/* –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π */
.msg.editing {
  border: 2px solid var(--accent-color);
  background: rgba(102, 126, 234, 0.1);
}

.edit-indicator {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-left: 0.5rem;
  color: var(--text-secondary);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è */
.typing-indicator {
  display: none;
  padding: 0.75rem 1.25rem;
  background: var(--user-msg);
  border-radius: 18px;
  border-bottom-left-radius: 6px;
  margin: 0 1.5rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
  width: fit-content;
}

.typing-indicator.active {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
.input-wrapper {
  display: flex;
  gap: 0.75rem;
  width: 100%;
}

.template-toggle {
  padding: 0.75rem;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  cursor: pointer;
  font-size: 1.2rem;
  transition: var(--transition);
  color: var(--text-primary);
}

.template-toggle:hover, .template-toggle.active {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
}

/* –ü–æ–∏—Å–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞–º */
.template-search {
  width: 100%;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-primary);
}

/* ... –û–°–¢–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ... */

/* ==== –°–¢–ê–†–´–ï –°–¢–ò–õ–ò (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ==== */
/* ==== CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–î–õ–Ø –¢–ï–ú) ==== */
:root {
  --bg-primary: #f0f4f8;
  --bg-secondary: #ffffff;
  --bg-header: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --text-primary: #2d3748;
  --text-secondary: #718096;
  --operator-msg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --user-msg: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
  --border-color: #e2e8f0;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --accent-color: #667eea;
  --danger-color: #e53e3e;
  --success-color: #48bb78;
  --button-hover: #5a67d8;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark {
  --bg-primary: #1a202c;
  --bg-secondary: #2d3748;
  --bg-header: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  --text-primary: #e2e8f0;
  --text-secondary: #a0aec0;
  --operator-msg: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
  --user-msg: linear-gradient(135deg, #4a5568 0%, #718096 100%);
  --border-color: #4a5568;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.4);
  --accent-color: #667eea;
}

/* ==== –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ==== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  flex-direction: column;
  transition: var(--transition);
}

/* ==== HEADER ==== */
header {
  background: var(--bg-header);
  color: white;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-lg);
  z-index: 100;
}

header h3 {
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: -0.025em;
}

.header-buttons {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-icon {
  padding: 0.5rem;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-back {
  background: rgba(255,255,255,0.15);
  color: white;
}

.btn-back:hover {
  background: rgba(255,255,255,0.25);
}

.btn-end {
  background: var(--danger-color);
  color: white;
}

.btn-end:hover {
  background: #c53030;
  transform: translateY(-1px);
}

.btn-theme {
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 1.2rem;
}

.btn-theme:hover {
  background: rgba(255,255,255,0.2);
}

/* ==== –û–ë–õ–ê–°–¢–¨ –°–û–û–ë–©–ï–ù–ò–ô ==== */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: var(--bg-primary);
  scroll-behavior: smooth;
}

#messages::-webkit-scrollbar {
  width: 8px;
}

#messages::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

#messages::-webkit-scrollbar-thumb {
  background: var(--text-secondary);
  border-radius: 4px;
}

.msg-wrapper {
  display: flex;
  animation: fadeInMsg 0.4s ease-out;
}

@keyframes fadeInMsg {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.msg-wrapper.operator {
  justify-content: flex-end;
}

.msg-wrapper.user {
  justify-content: flex-start;
}

.msg {
  max-width: 70%;
  padding: 1rem 1.25rem;
  border-radius: 18px;
  font-size: 0.95rem;
  line-height: 1.5;
  box-shadow: var(--shadow);
  position: relative;
  animation: bubbleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes bubbleIn {
  0% { transform: scale(0.8); }
  100% { transform: scale(1); }
}

.msg-wrapper.operator .msg {
  background: var(--operator-msg);
  color: white;
  border-bottom-right-radius: 6px;
}

.msg-wrapper.user .msg {
  background: var(--user-msg);
  color: var(--text-primary);
  border-bottom-left-radius: 6px;
}

.msg-time {
  font-size: 0.75rem;
  margin-top: 0.5rem;
  opacity: 0.8;
}

.msg-wrapper.operator .msg-time {
  color: rgba(255,255,255,0.8);
  text-align: right;
}

.msg-wrapper.user .msg-time {
  color: var(--text-secondary);
  text-align: left;
}

/* ==== –ü–û–õ–ï –í–í–û–î–ê ==== */
#inputBar {
  background: var(--bg-secondary);
  padding: 1rem 1.5rem;
  display: flex;
  gap: 1rem;
  border-top: 1px solid var(--border-color);
  box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
}

#answer {
  flex: 1;
  padding: 0.875rem 1.25rem;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  font-family: inherit;
  resize: none;
  transition: var(--transition);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 50px;
  max-height: 120px;
}

#answer:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.sendBtn {
  background: var(--accent-color);
  color: white;
  padding: 0 1.75rem;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.sendBtn:hover:not(:disabled) {
  background: var(--button-hover);
  transform: translateY(-1px);
}

.sendBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ==== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  animation: fadeIn 0.3s ease-out;
  backdrop-filter: blur(4px);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-secondary);
  margin: 10% auto;
  padding: 2rem;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
  from {
    transform: translateY(30px) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.modal-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

.close {
  font-size: 2rem;
  font-weight: 300;
  cursor: pointer;
  color: var(--text-secondary);
  line-height: 1;
  transition: var(--transition);
}

.close:hover {
  color: var(--text-primary);
  transform: scale(1.1);
}

.modal-body p {
  margin-bottom: 0.75rem;
  color: var(--text-secondary);
  font-size: 0.875rem;
}

#finalMessage {
  width: 100%;
  padding: 1rem;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-family: inherit;
  font-size: 0.95rem;
  resize: vertical;
  min-height: 80px;
  transition: var(--transition);
  background: var(--bg-primary);
  color: var(--text-primary);
}

#finalMessage:focus {
  outline: none;
  border-color: var(--accent-color);
}

.modal-footer {
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

.modal-footer button {
  padding: 0.625rem 1.25rem;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.modal-footer button:first-child {
  background: var(--bg-primary);
  color: var(--text-secondary);
}

.modal-footer button:first-child:hover {
  background: var(--border-color);
  color: var(--text-primary);
}

.modal-footer button:last-child {
  background: var(--danger-color);
  color: white;
}

.modal-footer button:last-child:hover {
  background: #c53030;
  transform: translateY(-1px);
}

/* ==== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ==== */
@media (max-width: 768px) {
  header {
    padding: 0.75rem 1rem;
  }
  
  header h3 {
    font-size: 1.1rem;
  }
  
  .btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }
  
  #messages {
    padding: 1rem;
  }
  
  .msg {
    max-width: 85%;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    border-radius: 16px;
  }
  
  .msg-time {
    font-size: 0.7rem;
  }
  
  #inputBar {
    padding: 0.75rem 1rem;
    flex-wrap: wrap;
  }
  
  .template-toggle {
    order: -1; /* –ö–Ω–æ–ø–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ —Å–≤–µ—Ä—Ö—É */
  }
}

@media (max-width: 480px) {
  .header-buttons {
    gap: 0.5rem;
  }
  
  .btn span:not(.btn-icon) {
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö, –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏ */
  }
}
</style>
</head>
<body>
<header>
  <div class="header-buttons">
    <button class="btn btn-back" onclick="goBack()">
      <span class="btn-icon">‚¨Ö</span> <span>–ù–∞–∑–∞–¥</span>
    </button>
  </div>
  
  <h3>{{ username }}</h3>
  
  <div class="header-buttons">
    <button class="btn btn-end" onclick="openEndModal()">
      <span>‚úîÔ∏è</span> <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
    </button>
    <button class="btn btn-theme" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
  </div>
</header>

<div id="messages">
  {% for msg in history %}
    <div class="msg-wrapper {% if msg.sender == 'operator' %}operator{% else %}user{% endif %}" 
         data-msg-id="{{ msg.id }}"
         data-timestamp="{{ msg.timestamp }}">
      <div class="msg">
        {{ msg.text }}
        <div class="msg-time">{{ msg.timestamp|default('') }}</div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
<div class="typing-indicator" id="typingIndicator">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç...</div>

<!-- –ü–∞–Ω–µ–ª—å —à–∞–±–ª–æ–Ω–æ–≤ -->
<div class="templates-panel" id="templatesPanel">
  <input type="text" class="template-search" id="templateSearch" placeholder="üîç –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–æ–≤...">
  <button class="template-btn category" data-category="greeting">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</button>
  <button class="template-btn category" data-category="faq">‚ùì FAQ</button>
  <button class="template-btn category" data-category="closing">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</button>
  <button class="template-btn category" data-category="custom">‚≠ê –ú–æ–∏</button>
  <a class="manage-templates-link" onclick="openTemplateManager()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</a>
</div>

<div id="inputBar">
  <button class="template-toggle" id="templateToggle" onclick="toggleTemplates()" title="–®–∞–±–ª–æ–Ω—ã (Ctrl+/)">üìù</button>
  <div class="input-wrapper">
    <textarea id="answer" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)" rows="2"></textarea>
    <button class="sendBtn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å (Enter)">
      <span>üì§</span> <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
    </button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–í–ï–†–®–ï–ù–ò–Ø -->
<div id="endModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞</h3>
      <span class="close" onclick="closeEndModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</p>
      <textarea id="finalMessage" rows="3">üë§ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–∞–ø–∏—à–∏—Ç–µ —Å–Ω–æ–≤–∞.</textarea>
      <small style="opacity:0.7;">–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.</small>
    </div>
    <div class="modal-footer">
      <button onclick="closeEndModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="endBtn" onclick="confirmEndChat()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –®–ê–ë–õ–û–ù–ê–ú–ò -->
<div id="templateModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</h3>
      <span class="close" onclick="closeTemplateManager()">&times;</span>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 1rem;">
        <select id="templateCategory" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
          <option value="greeting">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</option>
          <option value="faq">‚ùì FAQ</option>
          <option value="closing">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</option>
          <option value="custom">‚≠ê –ú–æ–∏</option>
        </select>
        <input type="text" id="templateName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
        <textarea id="templateText" rows="3" placeholder="–¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞..." style="width: 100%; padding: 0.5rem;"></textarea>
        <button onclick="saveTemplate()" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      </div>
      <div id="templateList" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeTemplateManager()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button onclick="importDefaults()">–°–±—Ä–æ—Å–∏—Ç—å –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö</button>
    </div>
  </div>
</div>

<script>
const user_id = "{{ user_id }}";
const socket = io();
const msgDiv = document.getElementById('messages');
const answer = document.getElementById('answer');
const endModal = document.getElementById('endModal');
const finalMessageInput = document.getElementById('finalMessage');
const templatesPanel = document.getElementById('templatesPanel');
const templateModal = document.getElementById('templateModal');
const typingIndicator = document.getElementById('typingIndicator');

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–ê–ë–õ–û–ù–ê–ú–ò ===

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
const defaultTemplates = {
  greeting: [
    { name: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç {{operator_name}}, —è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –¶–ó–ù. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' },
    { name: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å', text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤–∞—à–µ–º –≤–æ–ø—Ä–æ—Å–µ.' },
  ],
  faq: [
    { name: '–í–∞–∫–∞–Ω—Å–∏–∏', text: '–í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã" –∏–ª–∏ –ø—Ä–∏–π—Ç–∏ –∫ –Ω–∞–º –≤ —Ü–µ–Ω—Ç—Ä.' },
    { name: '–î–æ–∫—É–º–µ–Ω—Ç—ã', text: '–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–° –∏ —Ç—Ä—É–¥–æ–≤–∞—è –∫–Ω–∏–∂–∫–∞ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏).' },
    { name: '–ó–∞–ø–∏—Å—å', text: '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º –º–æ–∂–Ω–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 8-800-XXX-XX-XX –∏–ª–∏ —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏.' },
  ],
  closing: [
    { name: '–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ', text: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ. –í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ!' },
    { name: '–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è', text: '–†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è.' },
  ],
  custom: []
};

// –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ localStorage
function loadTemplates() {
  const saved = localStorage.getItem('chatTemplates');
  if (saved) {
    return JSON.parse(saved);
  }
  return JSON.parse(JSON.stringify(defaultTemplates)); // –ö–æ–ø–∏—Ä—É–µ–º defaults
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –≤ localStorage
function saveTemplatesToStorage(templates) {
  localStorage.setItem('chatTemplates', JSON.stringify(templates));
}

let templates = loadTemplates();

// –í—Å—Ç–∞–≤–∫–∞ —à–∞–±–ª–æ–Ω–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
function insertTemplate(text) {
  const cursorPos = answer.selectionStart;
  const textBefore = answer.value.substring(0, cursorPos);
  const textAfter = answer.value.substring(cursorPos);
  
  // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  const operatorName = "{{ session.get('username', '–û–ø–µ—Ä–∞—Ç–æ—Ä') }}";
  const processedText = text.replace('{{operator_name}}', operatorName);
  
  answer.value = textBefore + processedText + textAfter;
  answer.focus();
  answer.setSelectionRange(cursorPos + processedText.length, cursorPos + processedText.length);
  
  // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —à–∞–±–ª–æ–Ω–æ–≤
  templatesPanel.classList.remove('active');
  document.getElementById('templateToggle').classList.remove('active');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —à–∞–±–ª–æ–Ω–æ–≤
function toggleTemplates() {
  const isActive = templatesPanel.classList.toggle('active');
  document.getElementById('templateToggle').classList.toggle('active', isActive);
  if (isActive) {
    renderTemplates();
    document.getElementById('templateSearch').focus();
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–æ–≤
function renderTemplates(filter = '') {
  const panel = templatesPanel;
  const categoryButtons = panel.querySelectorAll('.template-btn.category');
  const currentCategory = document.querySelector('.template-btn.category.active')?.dataset.category || 'greeting';
  
  // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã (–∫—Ä–æ–º–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
  const oldTemplates = panel.querySelectorAll('.template-btn:not(.category):not(.manage-templates-link)');
  oldTemplates.forEach(btn => btn.remove());
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã
  const categoryTemplates = templates[currentCategory] || [];
  const filtered = categoryTemplates.filter(t => 
    t.name.toLowerCase().includes(filter.toLowerCase()) || 
    t.text.toLowerCase().includes(filter.toLowerCase())
  );
  
  // –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω—ã
  filtered.forEach((template, index) => {
    const btn = document.createElement('button');
    btn.className = 'template-btn';
    btn.textContent = template.name;
    btn.title = template.text.length > 50 ? template.text : '';
    btn.onclick = () => insertTemplate(template.text);
    panel.appendChild(btn);
  });
}

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
document.querySelectorAll('.template-btn.category').forEach(btn => {
  btn.addEventListener('click', (e) => {
    document.querySelectorAll('.template-btn.category').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    renderTemplates(document.getElementById('templateSearch').value);
  });
});

// –ü–æ–∏—Å–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞–º
document.getElementById('templateSearch').addEventListener('input', (e) => {
  renderTemplates(e.target.value);
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
function openTemplateManager() {
  templateModal.style.display = 'block';
  refreshTemplateList();
  templatesPanel.classList.remove('active');
  document.getElementById('templateToggle').classList.remove('active');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
function closeTemplateManager() {
  templateModal.style.display = 'none';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
function saveTemplate() {
  const category = document.getElementById('templateCategory').value;
  const name = document.getElementById('templateName').value.trim();
  const text = document.getElementById('templateText').value.trim();
  
  if (!name || !text) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞!');
    return;
  }
  
  templates[category].push({ name, text });
  saveTemplatesToStorage(templates);
  
  document.getElementById('templateName').value = '';
  document.getElementById('templateText').value = '';
  
  refreshTemplateList();
  alert('‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
}

// –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
function deleteTemplate(category, index) {
  if (confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) {
    templates[category].splice(index, 1);
    saveTemplatesToStorage(templates);
    refreshTemplateList();
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ
function refreshTemplateList() {
  const list = document.getElementById('templateList');
  list.innerHTML = '';
  
  Object.entries(templates).forEach(([category, items]) => {
    if (items.length === 0) return;
    
    const categoryDiv = document.createElement('div');
    categoryDiv.style.marginBottom = '1rem';
    
    const title = document.createElement('h4');
    title.textContent = {
      greeting: 'üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
      faq: '‚ùì FAQ',
      closing: '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ',
      custom: '‚≠ê –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã'
    }[category];
    title.style.marginBottom = '0.5rem';
    categoryDiv.appendChild(title);
    
    items.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.display = 'flex';
      itemDiv.style.justifyContent = 'space-between';
      itemDiv.style.alignItems = 'center';
      itemDiv.style.padding = '0.5rem';
      itemDiv.style.background = 'var(--bg-primary)';
      itemDiv.style.borderRadius = '8px';
      itemDiv.style.marginBottom = '0.25rem';
      
      itemDiv.innerHTML = `
        <div style="flex: 1; margin-right: 0.5rem;">
          <strong>${item.name}:</strong> ${item.text.substring(0, 50)}${item.text.length > 50 ? '...' : ''}
        </div>
        <button onclick="deleteTemplate('${category}', ${index})" style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      
      categoryDiv.appendChild(itemDiv);
    });
    
    list.appendChild(categoryDiv);
  });
}

// –°–±—Ä–æ—Å –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
function importDefaults() {
  if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º? –í–∞—à–∏ —à–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
    templates = JSON.parse(JSON.stringify(defaultTemplates));
    saveTemplatesToStorage(templates);
    refreshTemplateList();
    renderTemplates();
  }
}

// === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç)
function canEditMessage(msgWrapper) {
  const sender = msgWrapper.classList.contains('operator') ? 'operator' : 'user';
  if (sender !== 'operator') return false;
  
  const timestamp = msgWrapper.dataset.timestamp;
  if (!timestamp) return true; // –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
  
  const msgTime = new Date(timestamp).getTime();
  const now = new Date().getTime();
  const fiveMinutes = 5 * 60 * 1000;
  
  return (now - msgTime) < fiveMinutes;
}

// –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function enableEditMode(msgWrapper) {
  if (!canEditMessage(msgWrapper)) {
    if (msgWrapper.classList.contains('operator')) {
      alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥.');
    }
    return;
  }
  
  const msgDiv = msgWrapper.querySelector('.msg');
  const text = msgDiv.childNodes[0].textContent;
  const timeDiv = msgDiv.querySelector('.msg-time');
  
  msgDiv.classList.add('editing');
  
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.width = '100%';
  textarea.style.minHeight = '60px';
  textarea.style.border = 'none';
  textarea.style.borderRadius = '8px';
  textarea.style.padding = '0.5rem';
  textarea.style.fontFamily = 'inherit';
  textarea.style.fontSize = '0.95rem';
  textarea.style.resize = 'vertical';
  
  const saveBtn = document.createElement('button');
  saveBtn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  saveBtn.style.marginTop = '0.5rem';
  saveBtn.style.marginRight = '0.5rem';
  saveBtn.style.padding = '0.25rem 0.5rem';
  saveBtn.style.border = 'none';
  saveBtn.style.borderRadius = '4px';
  saveBtn.style.background = 'var(--success-color)';
  saveBtn.style.color = 'white';
  saveBtn.style.cursor = 'pointer';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '‚ùå –û—Ç–º–µ–Ω–∞';
  cancelBtn.style.marginTop = '0.5rem';
  cancelBtn.style.padding = '0.25rem 0.5rem';
  cancelBtn.style.border = 'none';
  cancelBtn.style.borderRadius = '4px';
  cancelBtn.style.background = 'var(--text-secondary)';
  cancelBtn.style.color = 'white';
  cancelBtn.style.cursor = 'pointer';
  
  // –û—á–∏—Å—Ç–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  msgDiv.innerHTML = '';
  msgDiv.appendChild(textarea);
  msgDiv.appendChild(document.createElement('br'));
  msgDiv.appendChild(saveBtn);
  msgDiv.appendChild(cancelBtn);
  msgDiv.appendChild(timeDiv);
  
  textarea.focus();
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  async function saveEdit() {
    const newText = textarea.value.trim();
    if (!newText) {
      alert('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
      return;
    }
    
    const msgId = msgWrapper.dataset.msgId;
    if (!msgId) {
      alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–º–µ–µ—Ç ID.');
      return;
    }
    
    try {
      const response = await fetch('/edit_message/' + msgId, {
        method: 'POST',
        body: new URLSearchParams({ text: newText })
      });
      
      const result = await response.json();
      
      if (result.status === 'ok') {
        msgDiv.classList.remove('editing');
        msgDiv.innerHTML = `${newText}<div class="msg-time">${timeDiv.textContent} <span class="edit-indicator">(—Ä–µ–¥.)</span></div>`;
      } else {
        throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + error.message);
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
      msgDiv.classList.remove('editing');
      msgDiv.innerHTML = `${text}<div class="msg-time">${timeDiv.textContent}</div>`;
    }
  }
  
  saveBtn.onclick = saveEdit;
  
  cancelBtn.onclick = () => {
    msgDiv.classList.remove('editing');
    msgDiv.innerHTML = `${text}<div class="msg-time">${timeDiv.textContent}</div>`;
  };
  
  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      saveEdit();
    }
  });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
document.addEventListener('DOMContentLoaded', () => {
  msgDiv.addEventListener('dblclick', (e) => {
    const msgWrapper = e.target.closest('.msg-wrapper');
    if (msgWrapper) {
      enableEditMode(msgWrapper);
    }
  });
});

// === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø ===

// –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
let draftInterval;
answer.addEventListener('input', () => {
  clearTimeout(draftInterval);
  draftInterval = setTimeout(() => {
    localStorage.setItem(`draft_${user_id}`, answer.value);
    console.log('üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }, 500);
});

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
window.addEventListener('load', () => {
  const draft = localStorage.getItem(`draft_${user_id}`);
  if (draft && !answer.value) {
    if (confirm('–ù–∞–π–¥–µ–Ω –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?')) {
      answer.value = draft;
    }
  }
});

// –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
function clearDraft() {
  localStorage.removeItem(`draft_${user_id}`);
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
let typingTimeout;
socket.on('typing', data => {
  if (data.user_id === user_id && data.sender === 'user') {
    clearTimeout(typingTimeout);
    typingIndicator.classList.add('active');
    typingTimeout = setTimeout(() => {
      typingIndicator.classList.remove('active');
    }, 3000);
  }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø–µ—á–∞—Ç–∞–Ω–∏—è (–æ–ø–µ—Ä–∞—Ç–æ—Ä)
answer.addEventListener('input', () => {
  socket.emit('typing', { user_id: user_id, sender: 'operator' });
});

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
window.addEventListener('beforeunload', (e) => {
  if (answer.value.trim() && answer.value !== localStorage.getItem(`draft_${user_id}`)) {
    e.preventDefault();
    e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–π—Ç–∏?';
  }
});

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô (–æ–±–Ω–æ–≤–ª–µ–Ω–æ) ===
function getTheme() {
  return localStorage.getItem('theme') || 'light';
}

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }
  localStorage.setItem('theme', theme);
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏
  socket.emit('theme_changed', { theme: theme });
}

function toggleTheme() {
  const newTheme = getTheme() === 'light' ? 'dark' : 'light';
  applyTheme(newTheme);
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    applyTheme(e.newValue);
  }
});

// === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–í–ï–†–®–ï–ù–ò–Ø ===

function openEndModal() {
  endModal.style.display = 'block';
}

function closeEndModal() {
  endModal.style.display = 'none';
}

async function confirmEndChat() {
  const message = finalMessageInput.value.trim();
  if (!message) {
    alert('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
    return;
  }
  
  closeEndModal();
  
  const endBtn = document.querySelector('.btn-end');
  endBtn.disabled = true;
  endBtn.innerHTML = '<span>‚è≥</span> <span>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...</span>';
  
  try {
    const response = await fetch('/end_chat/' + user_id, {
      method: 'POST',
      body: new URLSearchParams({ message: message })
    });
    
    const result = await response.json();
    
    if (result.status === 'ok') {
      addMessageToUI(message, '–û–ø–µ—Ä–∞—Ç–æ—Ä');
      alert('‚úÖ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.');
      clearDraft();
      setTimeout(() => window.location.href = '/dashboard', 1500);
    } else {
      throw new Error(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è');
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:', error);
    alert('–û—à–∏–±–∫–∞: ' + error.message);
    endBtn.disabled = false;
    endBtn.innerHTML = '<span>‚úîÔ∏è</span> <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>';
  }
}

// === –†–ê–ë–û–¢–ê –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò ===

function addMessageToUI(text, from, timestamp = null, isEdited = false) {
  const wrapper = document.createElement("div");
  wrapper.className = "msg-wrapper " + (from === "–û–ø–µ—Ä–∞—Ç–æ—Ä" ? "operator" : "user");
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  const msgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  wrapper.dataset.msgId = msgId;
  
  const msg = document.createElement("div");
  msg.className = "msg";
  const time = timestamp || new Date().toLocaleTimeString('ru-RU', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  const editIndicator = isEdited ? ' <span class="edit-indicator">(—Ä–µ–¥.)</span>' : '';
  msg.innerHTML = `${text}<div class="msg-time">${time}${editIndicator}</div>`;
  
  wrapper.appendChild(msg);
  msgDiv.appendChild(wrapper);
  msgDiv.scrollTop = msgDiv.scrollHeight;
}

async function sendMessage() {
  const text = answer.value.trim();
  if (!text) return;
  
  const sendBtn = document.querySelector('.sendBtn');
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span>‚è≥</span> <span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
  
  try {
    const response = await fetch('/reply/' + user_id, {
      method: 'POST',
      body: new URLSearchParams({ answer: text })
    });
    
    if (!response.ok) {
      throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.status === 'ok') {
      addMessageToUI(text, '–û–ø–µ—Ä–∞—Ç–æ—Ä');
      answer.value = "";
      clearDraft();
    } else {
      throw new Error(result.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + error.message);
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<span>üì§</span> <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>';
  }
}

socket.on("message_" + user_id, data => {
  if (data.sender === 'user') {
    typingIndicator.classList.remove('active');
    addMessageToUI(data.text, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', data.timestamp);
  }
});

// === –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ===
document.addEventListener('keydown', (e) => {
  // Ctrl+/ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —à–∞–±–ª–æ–Ω–æ–≤
  if (e.ctrlKey && e.key === '/') {
    e.preventDefault();
    toggleTemplates();
  }
  
  // Ctrl+1-9 –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
  if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
    e.preventDefault();
    const index = parseInt(e.key) - 1;
    const category = document.querySelector('.template-btn.category.active')?.dataset.category || 'greeting';
    const templateList = templates[category];
    if (templateList[index]) {
      insertTemplate(templateList[index].text);
    }
  }
});

// Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
answer.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function goBack() {
  window.location.href = "/dashboard";
}

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
applyTheme(getTheme());

// –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
document.querySelector('.template-btn.category').classList.add('active');

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
window.onload = () => {
  msgDiv.scrollTop = msgDiv.scrollHeight;
  const draft = localStorage.getItem(`draft_${user_id}`);
  if (draft && !answer.value) {
    answer.value = draft;
  }
};
</script>
</body>
</html>