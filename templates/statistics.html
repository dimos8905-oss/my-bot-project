<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Ä¢ –¶–ó–ù –†—è–∑–∞–Ω—å</title>
<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #f0f4f8; --bg-secondary: #ffffff; --bg-sidebar: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --text-primary: #2d3748; --text-secondary: #718096; --text-sidebar: #ffffff; --text-sidebar-muted: rgba(255,255,255,0.7);
  --accent: #667eea; --danger: #e53e3e; --success: #38a169; --warning: #f6ad55; --border: #e2e8f0; --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1); --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
body.dark {
  --bg-primary: #1a202c; --bg-secondary: #2d3748; --text-primary: #e2e8f0; --text-secondary: #a0aec0; --border: #4a5568;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary); color: var(--text-primary); height: 100vh; overflow: hidden;
  transition: var(--transition);
}
.app-container {
  display: grid; grid-template-columns: 280px 1fr; height: 100vh; gap: 0;
}
.sidebar {
  position: sticky; top: 0; height: 100vh; overflow-y: auto; z-index: 100;
  background: var(--bg-sidebar); color: var(--text-sidebar); padding: 30px 20px;
  display: flex; flex-direction: column; box-shadow: var(--shadow-lg);
}
.logo-section { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--glass-border); }
.logo { width: 60px; height: 60px; background: rgba(255,255,255,0.15); border-radius: 16px; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(5px); }
.logo-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
.logo-subtitle { font-size: 12px; opacity: 0.7; }
.menu-list { display: flex; flex-direction: column; gap: 8px; flex: 1; }
.menu-item {
  padding: 14px 18px; border-radius: 12px; cursor: pointer; transition: var(--transition);
  display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text-sidebar);
  font-weight: 500; background: rgba(255,255,255,0.05); border: 1px solid transparent;
}
.menu-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
.menu-item.active { background: rgba(255,255,255,0.2); border-color: var(--glass-border); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.menu-icon { font-size: 20px; width: 24px; text-align: center; }
.menu-text { flex: 1; }
.menu-badge { background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; }
.menu-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--glass-border); }
.main-content { padding: 30px; overflow-y: auto; background: var(--bg-primary); }
.content-header { margin-bottom: 30px; }
.content-title { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
.content-subtitle { color: var(--text-secondary); font-size: 14px; }

/* === –§–ò–õ–¨–¢–†–´ === */
.filters-section {
  position: sticky; top: 0; z-index: 50; background: var(--bg-secondary); margin-bottom: 25px;
  border-radius: 16px; box-shadow: var(--shadow); padding: 20px; display: flex; gap: 12px;
  flex-wrap: wrap; align-items: center;
}
.filter-group { display: flex; flex-direction: column; gap: 4px; }
.filter-label { font-weight: 600; font-size: 12px; color: var(--text-secondary); }
.filter-input, .filter-select {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: 10px;
  background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;
}
.filter-input:focus, .filter-select:focus { outline: none; border-color: var(--accent); }
.btn {
  padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer;
  font-size: 14px; font-weight: 500; transition: var(--transition); height: fit-content;
}
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: #5a67d8; transform: translateY(-1px); }
.btn-success { background: var(--success); color: white; }

/* === –°–í–û–î–ö–ê === */
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
}
.stat-card {
  background: var(--bg-secondary); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
  display: flex; align-items: center; gap: 15px; border: 1px solid var(--border);
}
.stat-icon {
  width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;
}
.stat-icon.blue { background: #e0f2fe; color: #0c4a6e; }
.stat-icon.green { background: #dcfce7; color: #166534; }
.stat-icon.orange { background: #fed7aa; color: #9a3412; }
.stat-icon.purple { background: #e9d5ff; color: #6b21a8; }
.stat-content { flex: 1; }
.stat-value {
  font-size: 28px; font-weight: 700; color: var(--text-primary); line-height: 1;
}
.stat-label {
  font-size: 12px; color: var(--text-secondary); margin-top: 4px;
}

/* === –ì–†–ê–§–ò–ö === */
.chart-container {
  background: var(--bg-secondary); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
  margin-bottom: 30px; border: 1px solid var(--border);
}
.chart-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
}
.chart-title {
  font-size: 18px; font-weight: 600; color: var(--text-primary);
}
.chart-bar {
  display: flex; align-items: flex-end; height: 200px; gap: 4px; margin-top: 10px;
}
.bar {
  flex: 1; background: var(--accent); border-radius: 4px 4px 0 0; min-height: 5px;
  position: relative; cursor: pointer; transition: var(--transition);
}
.bar:hover { background: #5a67d8; transform: scaleY(1.05); }
.bar-label {
  position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
  font-size: 10px; color: var(--text-secondary); white-space: nowrap;
}
.bar-value {
  position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
  font-size: 11px; font-weight: 600; background: var(--bg-primary); padding: 2px 6px;
  border-radius: 4px; border: 1px solid var(--border);
}

/* === –†–ï–ô–¢–ò–ù–ì === -->
.ranking-section {
  background: var(--bg-secondary); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
  margin-bottom: 30px; border: 1px solid var(--border);
}
.ranking-table {
  width: 100%; border-collapse: collapse; margin-top: 15px;
}
.ranking-table th {
  text-align: left; padding: 12px; font-size: 12px; font-weight: 600; color: var(--text-secondary);
  border-bottom: 2px solid var(--border); position: sticky; top: 0; background: var(--bg-secondary);
}
.ranking-table td {
  padding: 12px; font-size: 14px; border-bottom: 1px solid var(--border);
}
.ranking-table tr:hover { background: var(--bg-primary); }
.user-cell { display: flex; align-items: center; gap: 10px; }
.user-avatar {
  width: 32px; height: 32px; border-radius: 50%; background: var(--accent);
  display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;
}
.status-badge {
  padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
}
.status-active { background: #dcfce7; color: #166534; }
.status-inactive { background: #fee2e2; color: #dc2626; }

/* === –¢–ê–ë–õ–ò–¶–ê –î–ï–¢–ê–õ–ï–ô === */
.details-section {
  background: var(--bg-secondary); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
  border: 1px solid var(--border);
}
.details-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
}
.details-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
}
.details-table th {
  text-align: left; padding: 10px; font-weight: 600; color: var(--text-secondary);
  border-bottom: 2px solid var(--border); position: sticky; top: 0; background: var(--bg-secondary);
}
.details-table td {
  padding: 10px; border-bottom: 1px solid var(--border);
}
.details-table tr:hover { background: var(--bg-primary); }
.action-badge {
  padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: capitalize;
}
.action-message { background: #e0f2fe; color: #0c4a6e; }
.action-subscription { background: #dcfce7; color: #166534; }
.action-unsubscription { background: #fee2e2; color: #dc2626; }
.action-post { background: #e9d5ff; color: #6b21a8; }

.pagination {
  display: flex; gap: 8px; justify-content: center; margin-top: 20px; align-items: center;
}
.pagination button {
  padding: 6px 12px; border: 1px solid var(--border); background: var(--bg-secondary);
  color: var(--text-primary); border-radius: 8px; cursor: pointer; transition: var(--transition);
}
.pagination button:hover { background: var(--bg-primary); }
.pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination button.active { background: var(--accent); color: white; border-color: var(--accent); }

@media (max-width: 768px) {
  .app-container { grid-template-columns: 1fr; }
  .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; transform: translateX(-100%); z-index: 1000; transition: transform 0.3s; }
  .sidebar.open { transform: translateX(0); }
  .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .chart-bar { height: 150px; }
}
@media (min-width: 769px) { .menu-toggle { display: none; } }
@media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }
</style>
</head>
<body>
{% if session.get('logged_in') %}
<div class="app-container">
  <nav class="sidebar" aria-label="–ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="logo-section">
      <div class="logo">üè¢</div>
      <div class="logo-title">–¶–ó–ù –†—è–∑–∞–Ω—å</div>
      <div class="logo-subtitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
    </div>
    <div class="menu-list">
      <a href="/dashboard" class="menu-item">
        <span class="menu-icon" aria-hidden="true">üìã</span>
        <span class="menu-text">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</span>
        <span class="menu-badge" id="active-count">0</span>
      </a>
      <a href="/statistics" class="menu-item active" aria-current="page">
        <span class="menu-icon" aria-hidden="true">üìä</span>
        <span class="menu-text">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
      </a>
      <a href="/settings" class="menu-item">
        <span class="menu-icon" aria-hidden="true">‚öôÔ∏è</span>
        <span class="menu-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
      <a href="/logout" class="menu-item">
        <span class="menu-icon" aria-hidden="true">üö™</span>
        <span class="menu-text">–í—ã—Ö–æ–¥</span>
      </a>
    </div>
    <div class="menu-footer">
      <small style="opacity: 0.6; padding: 0 18px;">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞: Luiz</small>
    </div>
  </nav>

  <main class="main-content">
    <div class="content-header">
      <h1 class="content-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–ø–ø—ã</h1>
      <p class="content-subtitle">–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ -->
    <div class="filters-section">
      <div class="filter-group">
        <label class="filter-label">–î–∞—Ç–∞ –æ—Ç</label>
        <input type="date" class="filter-input" id="dateFrom" onchange="loadStats()">
      </div>
      <div class="filter-group">
        <label class="filter-label">–î–∞—Ç–∞ –¥–æ</label>
        <input type="date" class="filter-input" id="dateTo" onchange="loadStats()">
      </div>
      <div class="filter-group">
        <label class="filter-label">–¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è</label>
        <select class="filter-select" id="actionFilter" onchange="loadStats()">
          <option value="all">–í—Å–µ</option>
          <option value="message">–°–æ–æ–±—â–µ–Ω–∏—è</option>
          <option value="subscription">–ü–æ–¥–ø–∏—Å–∫–∏</option>
          <option value="unsubscription">–û—Ç–ø–∏—Å–∫–∏</option>
          <option value="post">–ü–æ—Å—Ç—ã</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
        <input type="text" class="filter-input" id="userSearch" placeholder="–ò–º—è –∏–ª–∏ ID" oninput="loadStats()">
      </div>
      <button class="btn btn-primary" onclick="loadStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn btn-success" onclick="exportToExcel()">üìä Excel</button>
    </div>

    <!-- –°–í–û–î–ö–ê -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">üìä</div>
        <div class="stat-content">
          <div class="stat-value" id="totalPosts">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üë•</div>
        <div class="stat-content">
          <div class="stat-value" id="totalSubs">0</div>
          <div class="stat-label">–ü–æ–¥–ø–∏—Å–æ–∫</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">‚¨ÖÔ∏è</div>
        <div class="stat-content">
          <div class="stat-value" id="totalUnsubs">0</div>
          <div class="stat-label">–û—Ç–ø–∏—Å–æ–∫</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">üí¨</div>
        <div class="stat-content">
          <div class="stat-value" id="totalMessages">0</div>
          <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue">üë§</div>
        <div class="stat-content">
          <div class="stat-value" id="activeUsers">0</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üìà</div>
        <div class="stat-content">
          <div class="stat-value" id="conversionRate">0%</div>
          <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        </div>
      </div>
    </div>

    <!-- –ì–†–ê–§–ò–ö –ê–ö–¢–ò–í–ù–û–°–¢–ò -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
        <span id="chartPeriod" style="font-size: 12px; color: var(--text-secondary);"></span>
      </div>
      <div class="chart-bar" id="activityChart"></div>
    </div>

    <!-- –†–ï–ô–¢–ò–ù–ì –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
    <div class="ranking-section">
      <h3>üèÜ –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
      <table class="ranking-table">
        <thead>
          <tr>
            <th>#</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–°–æ–æ–±—â–µ–Ω–∏—è</th>
            <th>–ü–æ–¥–ø–∏—Å–∫–∏</th>
            <th>–û—Ç–ø–∏—Å–∫–∏</th>
            <th>–†–µ–π—Ç–∏–Ω–≥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody id="rankingTable"></tbody>
      </table>
    </div>

    <!-- –î–ï–¢–ê–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê -->
    <div class="details-section">
      <div class="details-header">
        <h3 class="chart-title">üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3>
        <span style="font-size: 12px; color: var(--text-secondary);" id="totalRecords"></span>
      </div>
      <table class="details-table">
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th>
            <th>ID</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th>
          </tr>
        </thead>
        <tbody id="detailsTable"></tbody>
      </table>
      <div class="pagination" id="pagination"></div>
    </div>
  </main>
</div>

<script>
const socket = io({ reconnection: true, reconnectionAttempts: 5, reconnectionDelay: 1000 });
let statsData = { summary: {}, activity: [], ranking: [], details: [] };
let currentPage = 1;
const itemsPerPage = 20;

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
window.addEventListener('DOMContentLoaded', () => {
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
  const today = new Date();
  const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
  document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
  document.getElementById('dateTo').value = today.toISOString().split('T')[0];
  
  loadStats();
});

// === –ó–ê–ì–†–£–ó–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ===
function loadStats() {
  const filters = {
    dateFrom: document.getElementById('dateFrom').value,
    dateTo: document.getElementById('dateTo').value,
    action: document.getElementById('actionFilter').value,
    user: document.getElementById('userSearch').value
  };
  
  socket.emit('get_statistics', filters, (data) => {
    if (!data) {
      showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
      return;
    }
    
    statsData = data;
    updateSummary(data.summary);
    updateChart(data.activity);
    updateRanking(data.ranking);
    updateDetails(data.details);
    updatePagination(data.details.length);
  });
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–í–û–î–ö–ò ===
function updateSummary(summary) {
  document.getElementById('totalPosts').textContent = summary.total_posts || 0;
  document.getElementById('totalSubs').textContent = summary.total_subscriptions || 0;
  document.getElementById('totalUnsubs').textContent = summary.total_unsubscriptions || 0;
  document.getElementById('totalMessages').textContent = summary.total_messages || 0;
  document.getElementById('activeUsers').textContent = summary.active_users || 0;
  
  const conversion = summary.total_subscriptions && summary.total_unsubscriptions !== undefined
    ? Math.round((1 - summary.total_unsubscriptions / summary.total_subscriptions) * 100)
    : 100;
  document.getElementById('conversionRate').textContent = conversion + '%';
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–†–ê–§–ò–ö–ê ===
function updateChart(activity) {
  const chart = document.getElementById('activityChart');
  const period = document.getElementById('chartPeriod');
  chart.innerHTML = '';
  
  if (!activity || activity.length === 0) {
    chart.innerHTML = '<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
    return;
  }
  
  const maxValue = Math.max(...activity.map(a => a.actions));
  period.textContent = `–ü–µ—Ä–∏–æ–¥: ${activity[0].date} ‚Äî ${activity[activity.length - 1].date}`;
  
  activity.slice(-14).forEach(day => {
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = maxValue > 0 ? `${(day.actions / maxValue) * 180}px` : '5px';
    bar.title = `${day.date}: ${day.actions} –¥–µ–π—Å—Ç–≤–∏–π`;
    
    const label = document.createElement('span');
    label.className = 'bar-label';
    label.textContent = new Date(day.date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
    
    const value = document.createElement('span');
    value.className = 'bar-value';
    value.textContent = day.actions;
    
    bar.appendChild(label);
    bar.appendChild(value);
    chart.appendChild(bar);
  });
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –†–ï–ô–¢–ò–ù–ì–ê ===
function updateRanking(ranking) {
  const tbody = document.getElementById('rankingTable');
  tbody.innerHTML = '';
  
  if (!ranking || ranking.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    return;
  }
  
  ranking.slice(0, 10).forEach((user, index) => {
    const row = document.createElement('tr');
    const rating = calculateRating(user);
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>
        <div class="user-cell">
          <div class="user-avatar">${user.username?.charAt(0) || '?'}</div>
          <div>
            <div style="font-weight: 500;">${user.username}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">ID: ${user.user_id}</div>
          </div>
        </div>
      </td>
      <td>${user.messages || 0}</td>
      <td>${user.subscriptions || 0}</td>
      <td>${user.unsubscriptions || 0}</td>
      <td><strong>${rating}</strong></td>
      <td><span class="status-badge ${user.status || 'active'}">${user.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span></td>
    `;
    tbody.appendChild(row);
  });
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ï–¢–ê–õ–ï–ô ===
function updateDetails(details) {
  const tbody = document.getElementById('detailsTable');
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageData = details.slice(start, end);
  
  tbody.innerHTML = '';
  pageData.forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${record.timestamp}</td>
      <td>${record.user_id}</td>
      <td>${record.username}</td>
      <td><span class="action-badge action-${record.action}">${getActionLabel(record.action)}</span></td>
      <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${record.content || '-'}</td>
    `;
    tbody.appendChild(row);
  });
  
  document.getElementById('totalRecords').textContent = `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${details.length}`;
}

// === –ü–ê–ì–ò–ù–ê–¶–ò–Ø ===
function updatePagination(total) {
  const container = document.getElementById('pagination');
  const totalPages = Math.ceil(total / itemsPerPage);
  container.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
  const prev = document.createElement('button');
  prev.textContent = '‚Äπ';
  prev.disabled = currentPage === 1;
  prev.onclick = () => changePage(currentPage - 1);
  container.appendChild(prev);
  
  // –¶–∏—Ñ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = i === currentPage ? 'active' : '';
      btn.onclick = () => changePage(i);
      container.appendChild(btn);
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.style.color = 'var(--text-secondary)';
      container.appendChild(dots);
    }
  }
  
  // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
  const next = document.createElement('button');
  next.textContent = '‚Ä∫';
  next.disabled = currentPage === totalPages;
  next.onclick = () => changePage(currentPage + 1);
  container.appendChild(next);
}

function changePage(page) {
  currentPage = page;
  updateDetails(statsData.details);
  updatePagination(statsData.details.length);
}

// === –≠–ö–°–ü–û–†–¢ –í EXCEL ===
function exportToExcel() {
  if (!statsData.details || statsData.details.length === 0) {
    showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
    return;
  }
  
  showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel...', 'info');
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏
  const headers = ['–í—Ä–µ–º—è', 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', '–ò–º—è', '–î–µ–π—Å—Ç–≤–∏–µ', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ'];
  const rows = statsData.details.map(r => [
    r.timestamp,
    r.user_id,
    r.username,
    getActionLabel(r.action),
    r.content || ''
  ]);
  
  // –°–æ–∑–¥–∞–Ω–∏–µ CSV
  const csv = [headers, ...rows].map(row => 
    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
  ).join('\n');
  
  // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `statistika_czn_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showNotification('Excel —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω!', 'success');
}

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function getActionLabel(action) {
  const labels = {
    message: '–°–æ–æ–±—â–µ–Ω–∏–µ',
    subscription: '–ü–æ–¥–ø–∏—Å–∫–∞',
    unsubscription: '–û—Ç–ø–∏—Å–∫–∞',
    post: '–ü–æ—Å—Ç'
  };
  return labels[action] || action;
}

function calculateRating(user) {
  const messages = user.messages || 0;
  const subs = user.subscriptions || 0;
  const unsubs = user.unsubscriptions || 0;
  return Math.round(messages * 2 + subs * 5 - unsubs * 3);
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; padding: 12px 20px; z-index: 9999;
    background: ${type === 'error' ? '#e53e3e' : type === 'success' ? '#38a169' : '#3182ce'};
    color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

// === –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ ===
const menuToggle = document.createElement('button');
menuToggle.className = 'menu-toggle';
menuToggle.innerHTML = '‚ò∞';
menuToggle.setAttribute('aria-label', '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é');
menuToggle.setAttribute('aria-expanded', 'false');
menuToggle.onclick = () => {
  const sidebar = document.querySelector('.sidebar');
  sidebar.classList.toggle('open');
  menuToggle.setAttribute('aria-expanded', sidebar.classList.contains('open'));
};
document.body.appendChild(menuToggle);

document.addEventListener('click', (e) => {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
    sidebar.classList.remove('open');
    menuToggle.setAttribute('aria-expanded', 'false');
  }
});
</script>
{% else %}
<script>window.location.href = '/';</script>
{% endif %}
</body>
</html>